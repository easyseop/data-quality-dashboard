{% extends "layout.html" %}
{% block content %}

<style>
/* ğŸ”¥ ì§„í•œ ë¹¨ê°•/ì´ˆë¡ ì»¬ëŸ¬ ê°•ì¡° */
.error-row td {
    background-color: #ffe6e6 !important;
    color: #000 !important;
}
.normal-row td {
    background-color: #eaffea !important;
    color: #000 !important;
}

/* ì„ íƒ ì‹œ í…Œë‘ë¦¬ */
.column-row.selected {
    outline: 3px solid #0056b3 !important;
}
</style>

<h2>ğŸ“‘ Table Detail â€” {{ table_name }} ({{ selected_date }})</h2>

<div class="row">
    <div class="col-md-5">
        <table id="columnSummary" class="table table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th>Column</th>
                    <th>Error</th>
                    <th>Normal</th>
                    <th>Error Rate</th>
                </tr>
            </thead>
            <tbody>
                {% for col in columns %}
                <tr class="column-row
                    {% if col.error_cnt|int > 0 %}
                        error-row
                    {% else %}
                        normal-row
                    {% endif %}"
                    data-column="{{ col.column_name }}" style="cursor:pointer;">
                    <td>{{ col.column_name }}</td>
                    <td>{{ col.error_cnt }}</td>
                    <td>{{ col.normal_cnt }}</td>
                    <td>{{ col.error_rate }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="col-md-7">
        <h4>ğŸ” Column Value Distribution</h4>
        <div id="detailSection" class="mt-3">
            <p>ì™¼ìª½ì—ì„œ ì»¬ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function () {

    $("#columnSummary tbody").on("click", "tr", function () {

        $("#columnSummary tbody tr").removeClass("selected");
        $(this).addClass("selected");

        const columnName = $(this).data("column");

        $.ajax({
            url: "/detail/drilldown",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                table: "{{ table_name }}",
                column: columnName,
                date: "{{ selected_date }}"
            }),
            success: function(records){
                if (!records || records.length === 0 || (records.length === 1 && records[0].cnt === 0)) {
                    $("#detailSection").html(`
                        <div class="alert alert-info mt-2">
                            <b>${columnName}</b> ì»¬ëŸ¼ì€ ì˜¤ë¥˜ê°’ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ‰
                        </div>
                    `);
                    return;
                }

                let html = `
                <h5><b>${columnName}</b> â€” Value Distribution</h5>
                <table class="table table-striped">
                    <thead><tr><th>Error Type</th><th>Value</th><th>Count</th></tr></thead>
                    <tbody>
                `;

                records.forEach(r => {
                    html += `<tr><td>${r.error_type}</td><td>${r.sample_value}</td><td>${r.cnt}</td></tr>`;
                });

                html += "</tbody></table>";
                $("#detailSection").html(html);
            }
        });

    });

});
</script>
{% endblock %}
