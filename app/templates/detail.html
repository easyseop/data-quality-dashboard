{% extends "layout.html" %}
{% block content %}

<style>
.error-row td { background-color:#ffe6e6 !important; }
.normal-row td { background-color:#eaffea !important; }
.column-row.selected { outline:3px solid #0056b3 !important; }
</style>

<h2>ğŸ“‘ Table Detail â€” {{ table_name }} ({{ selected_date }})</h2>

{% if mode == "occa" %}
<p class="text-muted mt-2">
    ì„ íƒëœ ìˆ˜ì‹œ ê¸°ì¤€ì¼: <b>{{ selected_date }}</b><br>
    ì—°ê²°ëœ ì •ê¸° ê¸°ì¤€ì¼: <b>{{ regular_base }}</b>
</p>
{% endif %}

<div class="row">
    <!-- LEFT : Column Summary -->
    <div class="col-md-5">
        <table id="columnSummary" class="table table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th>Column</th>
                    <th>Error</th>
                    <th>Normal</th>
                    <th>Error Rate</th>
                </tr>
            </thead>
            <tbody>
                {% for col in columns %}
                <tr class="column-row
                    {% if col.error_cnt|int > 0 %}
                        error-row
                    {% else %}
                        normal-row
                    {% endif %}"
                    data-column="{{ col.column_name }}"
                    style="cursor:pointer;">
                    <td>{{ col.column_name }}</td>
                    <td>{{ col.error_cnt }}</td>
                    <td>{{ col.normal_cnt }}</td>
                    <td>{{ col.error_rate }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- RIGHT : Drilldown Result -->
    <div class="col-md-7">
        <h4>ğŸ” Column Value Distribution</h4>
        <div id="detailSection" class="mt-3">
            <p class="text-muted">ì™¼ìª½ì—ì„œ ì»¬ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”.</p>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DataTables ì‚¬ìš©í•œë‹¤ë©´ ë¬´ì¡°ê±´ í•„ìš” -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function () {

    // í…Œì´ë¸”ì´ DataTableë¡œ ì¬ëœë”ë§ë˜ëŠ” ê²½ìš° ëŒ€ë¹„
    if (!$.fn.DataTable.isDataTable('#columnSummary')) {
        $('#columnSummary').DataTable({
            paging: false,
            searching: false,
            info: false
        });
    }

    // ë°˜ë“œì‹œ delegate ë°©ì‹ ì‚¬ìš©
    $(document).on("click", "#columnSummary tbody tr", function () {

        $("#columnSummary tbody tr").removeClass("selected");
        $(this).addClass("selected");

        const columnName = $(this).data("column");

        $.ajax({
            url: `/detail/{{ mode }}/drilldown`,
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                table: "{{ table_name }}",
                column: columnName,
                date: "{{ selected_date }}",
                mode: "{{ mode }}"
            }),
            success: function(records){
                if (!records || records.length === 0 || (records.length === 1 && records[0].cnt === 0)) {
                    $("#detailSection").html(`
                        <div class="alert alert-info mt-2">
                            <b>${columnName}</b> ì»¬ëŸ¼ì€ ì˜¤ë¥˜ê°’ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ‰
                        </div>
                    `);
                    return;
                }

                let html = `
                <h5><b>${columnName}</b> â€” Value Distribution</h5>
                <table class="table table-striped">
                    <thead><tr><th>Error Type</th><th>Value</th><th>Count</th></tr></thead>
                    <tbody>
                `;

                records.forEach(r => {
                    html += `<tr><td>${r.error_type}</td><td>${r.sample_value}</td><td>${r.cnt}</td></tr>`;
                });

                html += "</tbody></table>";
                $("#detailSection").html(html);
            },
            error: function(xhr){
                console.log("ğŸ”¥ AJAX ì‹¤íŒ¨", xhr.responseText);
            }
        });

    });

});
</script>


{% endblock %}

