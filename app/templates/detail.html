{% extends "layout.html" %}
{% block content %}

<h2>ğŸ“‘ Table Detail â€” {{ table_name }}</h2>
<p>ì»¬ëŸ¼ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì˜¤ë¥˜ ìƒ˜í”Œì„ ì˜¤ë¥¸ìª½ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="row">
    <!-- Left: Column Summary -->
    <div class="col-md-5">
        <input type="text" id="columnSearch" class="form-control mb-2" placeholder="ğŸ” ì»¬ëŸ¼ëª… / ì˜¤ë¥˜ì¹´ìš´íŠ¸ / ì˜¤ë¥˜ìœ¨ ê²€ìƒ‰">
        <table id="columnSummary" class="table table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th>Column Name</th>
                    <th>Error Count</th>
                    <th>Error Rate</th>
                </tr>
            </thead>
            <tbody>
                {% for col in columns %}
                <tr class="column-row" data-column="{{ col.column }}" style="cursor:pointer;">
                    <td>{{ col.column }}</td>
                    <td>{{ col.error_cnt }}</td>
                    <td>{{ col.error_rate }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Right: Drill-down -->
    <div class="col-md-7">
        <h4>ğŸ” Column Error Detail</h4>
        <div id="detailSection" class="mt-3">
            <p>ì™¼ìª½ì—ì„œ ì»¬ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”.</p>
        </div>
    </div>
</div>

<!-- JSON DATA -->
<script id="detailDataJson" type="application/json">
    {{ detail_data | tojson | safe }}
</script>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function () {
    console.log("Detail page Loaded");

    const detailData = JSON.parse(document.getElementById("detailDataJson").textContent);
    const tableName = "{{ table_name }}";

    // ===== DataTable ì ìš© (ê²€ìƒ‰, í˜ì´ì§•, ì •ë ¬ ëª¨ë‘ í™œì„±í™”) =====
    const colTable = $('#columnSummary').DataTable({
        pageLength: 30,
        ordering: true,
        searching: true,
        paging: true,
        lengthChange: false
    });

    // ===== Custom Search Input ì—°ë™ =====
    $('#columnSearch').on('keyup', function () {
        colTable.search(this.value).draw();
    });

    // ===== Row Click ì´ë²¤íŠ¸ =====
    $('#columnSummary tbody').on('click', 'tr', function () {
        const columnName = $(this).data("column");
        console.log("Clicked column:", columnName);

        const records = detailData[tableName][columnName] || [];

        let html = `
        <h5><b>ğŸ“Œ ${columnName}</b></h5>
        <table class='table table-striped'>
            <thead><tr><th>Error Type</th><th>Sample Value</th><th>Count</th></tr></thead><tbody>
        `;

        records.forEach(item => {
            html += `<tr><td>${item.error_type}</td><td>${item.sample_value}</td><td>${item.cnt}</td></tr>`;
        });

        html += "</tbody></table>";

        $("#detailSection").html(html);
    });

    // Bootstrap ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ ì ìš©
    $('.dataTables_filter input').addClass('form-control form-control-sm');
});
</script>
{% endblock %}
