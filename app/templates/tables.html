{% extends "layout.html" %}
{% block content %}

<h2>ğŸ“‚ Table List</h2>
<p>í…Œì´ë¸” ê²€ìƒ‰ / í˜ì´ì§• / ì •ë ¬ / í´ë¦­ ìƒì„¸ ì´ë™</p>

<div class="row mb-3">
    <div class="col-md-2">
        <label><b>ë…„ë„</b></label>
        <select id="yearFilter" class="form-select">
            {% for y in year_list %}
            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}ë…„</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label><b>ê²€ì¦êµ¬ë¶„</b></label>
        <select id="dtypeFilter" class="form-select">
            {% for t in dtype_list %}
            <option value="{{ t }}" {% if t == selected_dtype %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label><b>ì°¨ìˆ˜</b></label>
        <select id="cycleFilter" class="form-select">
            {% for c in cycle_list %}
            <option value="{{ c }}" {% if c == selected_cycle %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label><b>App Code</b></label>
        <select id="appFilter" class="form-select">
            <option value="ALL" {% if selected_app == "ALL" %}selected{% endif %}>ALL</option>
            {% for app in app_code_list %}
            <option value="{{ app }}" {% if selected_app == app %}selected{% endif %}>{{ app }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<table id="tableList" class="table table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>App Code</th>
            <th>Table Name</th>
            <th>Error Count</th>
            <th>Normal Count</th>
            <th>Error Rate</th>
        </tr>
    </thead>
    <tbody>
        {% for t in tables %}
        <tr>
            <td>{{ t["ì–´í”Œë¦¬ì¼€ì´ì…˜ì½”ë“œ"] }}</td>
            <td>{{ t["í…Œì´ë¸”ëª…"] }}</td>
            <td>{{ t["error_cnt"] }}</td>
            <td>{{ t["normal_cnt"] }}</td>
            <td>{{ t["error_rate"] }}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function () {


    const table = $('#tableList').DataTable({
        pageLength: 50,
        ordering: true,
        order: [[2, 'asc']],
        searching: false,
        paging: true,
        deferRender: true,
        stateSave: false,    // ğŸ”§ ì €ì¥ ê¸°ëŠ¥ ë¹„í™œì„±í™”
        lengthChange: false
    });

    $("#yearFilter, #dtypeFilter, #cycleFilter, #appFilter").on("change", function () {
        const year  = $("#yearFilter").val();
        const dtype = $("#dtypeFilter").val();
        const cycle = $("#cycleFilter").val();
        const app   = $("#appFilter").val();

        let newUrl = `/tables?year=${year}&dtype=${dtype}&cycle=${cycle}`;
        if (app) newUrl += `&app=${app}`;

        window.location.href = newUrl;
    });

    $("#tableList").on("click", "tbody tr", function () {
        const tableName = $(this).find("td:eq(1)").text();
        window.location.href = `/detail/${tableName}?date={{ selected_base }}`;
    });

});
</script>

{% endblock %}
