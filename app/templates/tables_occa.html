{% extends "layout.html" %}
{% block content %}

<h2>ğŸ“‚ ìˆ˜ì‹œ í…Œì´ë¸” ëª©ë¡</h2>

<div class="row mb-3">
    <div class="col-md-2">
        <label><b>ë…„ë„</b></label>
        <select id="yearFilter" class="form-select">
            {% for y in year_list %}
            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}ë…„</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label><b>ì›”</b></label>
        <select id="monthFilter" class="form-select">
            {% for m in month_list %}
            <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>
                {{ m }}ì›”
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label><b>App Code</b></label>
        <select id="appFilter" class="form-select">
            <option value="ALL">ALL</option>
            {% for app in app_code_list %}
            <option value="{{ app }}" {% if app == selected_app %}selected{% endif %}>
                {{ app }}
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<p class="text-muted">
    ì„ íƒëœ ìˆ˜ì‹œ ê¸°ì¤€ì¼: <b>{{ selected_base }}</b><br>
    ì—°ê²°ëœ ì •ê¸° ê¸°ì¤€ì¼: <b>{{ selected_regular_base }}</b>
</p>

<table id="tableList" class="table table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>App</th>
            <th>Table Name</th>
            <th>Error Count</th>
            <th>Normal Count</th>
            <th>Error Rate</th>
        </tr>
    </thead>
    <tbody>
        {% for t in tables %}
        <tr>
            <td>{{ t["ì–´í”Œë¦¬ì¼€ì´ì…˜ì½”ë“œ"] }}</td>
            <td>{{ t["í…Œì´ë¸”ëª…"] }}</td>
            <td>{{ t["error_cnt"] }}</td>
            <td>{{ t["normal_cnt"] }}</td>
            <td>{{ t["error_rate"] }}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function () {

    const table = $('#tableList').DataTable({
        pageLength: 50,
        ordering: true,
        order: [[4, 'desc']],
        searching: false,
        paging: false,
        stateSave: false,
        lengthChange: false
    });

    $("#yearFilter, #monthFilter, #appFilter").on("change", function () {
        const year  = $("#yearFilter").val();
        const month = $("#monthFilter").val();
        const app   = $("#appFilter").val();

        let url = `/tables/occa?year=${year}&month=${month}`;
        if (app) url += `&app=${app}`;
        window.location.href = url;
    });

    // ğŸ”¥ í´ë¦­ ì‹œ detail í˜ì´ì§€ë¡œ ì´ë™
    table.on("click", "tbody tr", function () {
        const tableName = $(this).find("td:eq(1)").text().trim();
        if (!tableName) return;

        const baseDate = "{{ selected_base }}";
        const regularBase = "{{ selected_regular_base }}";  // ìˆ˜ì‹œ â†’ ì—°ê²°ëœ ì •ê¸° ê¸°ì¤€ì¼

        // ğŸ”¥ ì •ê¸° ê¸°ì¤€ì¼ì„ ë°˜ë“œì‹œ í¬í•¨í•´ì„œ ì „ë‹¬í•´ì•¼ detailì´ ì •ìƒ ì‘ë™í•œë‹¤.
        window.location.href =
            `/detail/occa/${tableName}?date=${baseDate}&regular=${regularBase}`;
    });

});
</script>


{% endblock %}
