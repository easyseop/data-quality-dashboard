{% extends "layout.html" %}
{% block content %}

<style>
    /* ğŸ”¥ ìœ„ì ¯ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .widget-block {
        background: #ffffff;
        padding: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 25px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* ğŸ”¥ ë“œë˜ê·¸ ì‹œ ìŠ¤íƒ€ì¼ */
    .dragging {
        opacity: 0.6;
        border: 2px dashed #007bff !important;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">ğŸ“Š Data Quality Dashboard</h2>

    <a href="/download/summary?date={{ selected_base }}" class="btn btn-outline-success shadow-sm px-3">
        <i class="bi bi-download"></i>
        <span>í†µê³„ì •ë³´ ë‹¤ìš´ë¡œë“œ</span>
    </a>
</div>


<!-- ğŸ”¥ í•„í„°: ë…„ë„ / ì°¨ìˆ˜ (ì •ê¸°ë§Œ ì§€ì›) -->
<form method="get" action="/" class="row mb-3">

    <div class="col-md-2">
        <label><b>ë…„ë„</b></label>
        <select name="year" class="form-select" onchange="this.form.submit()">
            {% for y in year_list %}
            <option value="{{ y }}" {% if y==selected_year %}selected{% endif %}>
                {{ y }}ë…„
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label><b>ê²€ì¦êµ¬ë¶„</b></label>
        <select name="dtype" class="form-select" onchange="this.form.submit()">
            <option value="ì •ê¸°" selected>ì •ê¸°</option>
            <option value="ìˆ˜ì‹œ" disabled>ìˆ˜ì‹œ(ì§€ì›ì•ˆí•¨)</option>
        </select>
    </div>

    <div class="col-md-2">
        <label><b>ì°¨ìˆ˜</b></label>
        <select name="cycle" class="form-select" onchange="this.form.submit()">
            {% for c in cycle_list %}
            <option value="{{ c }}" {% if c==selected_cycle %}selected{% endif %}>
                {{ c }}
            </option>
            {% endfor %}
        </select>
    </div>

</form>
<!-- í‘œì‹œ ì„¤ì • (ë“œë¡­ë‹¤ìš´) -->
<div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
        aria-expanded="false">
        âš™ í‘œì‹œ ì„¤ì •
    </button>

    <ul class="dropdown-menu p-3" style="min-width: 240px;" onclick="event.stopPropagation();">

        <div class="form-check">
            <input class="form-check-input widget-toggle" type="checkbox" id="widget_improve"
                data-target="#widget-improve" checked>
            <label class="form-check-label" for="widget_improve">ì˜¤ë¥˜ ê°œì„ ìœ¨</label>
        </div>

        <div class="form-check">
            <input class="form-check-input widget-toggle" type="checkbox" id="widget_kpi_trend"
                data-target="#widget-kpi-trend" checked>
            <label class="form-check-label" for="widget_kpi_trend">KPI ì¶”ì„¸ ê·¸ë˜í”„</label>
        </div>

        <div class="form-check">
            <input class="form-check-input widget-toggle" type="checkbox" id="widget_overall"
                data-target="#widget-overall" checked>
            <label class="form-check-label" for="widget_overall">Overall KPI</label>
        </div>

        <div class="form-check">
            <input class="form-check-input widget-toggle" type="checkbox" id="widget_quality"
                data-target="#widget-quality" checked>
            <label class="form-check-label" for="widget_quality">í’ˆì§ˆì§€ìˆ˜ ìš”ì•½</label>
        </div>

        <div class="form-check">
            <input class="form-check-input widget-toggle" type="checkbox" id="widget_maint" data-target="#widget-maint"
                checked>
            <label class="form-check-label" for="widget_maint">ì •ë¹„ê³„íš ë“±ë¡ë¥ </label>
        </div>

    </ul>
</div>

<hr class="my-4">

<!-- ===================== ìœ„ì ¯ ì„¹ì…˜ ===================== -->

<div id="widgets-container">
    <div id="widget-kpi-trend" class="widget-block">
        <div class="widget-content">
            {% include "widgets/widget_kpi_trend.html" %}
        </div>
    </div>

    <div id="widget-improve" class="widget-block">
        <div class="widget-content">
            {% include "widgets/widget_improve.html" %}
        </div>
    </div>

    <div id="widget-overall" class="widget-block">
        <div class="widget-content">
            {% include "widgets/widget_overall.html" %}
        </div>
    </div>

    <div id="widget-quality" class="widget-block">
        <div class="widget-content">
            {% include "widgets/widget_quality.html" %}
        </div>
    </div>

    <div id="widget-maint" class="widget-block">
        <div class="widget-content">
            {% include "widgets/widget_maint.html" %}
        </div>
    </div>
</div>

</div>

<!-- ===================== Scripts ===================== -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>



<script>
    $(document).ready(function () {

        /* -----------------------------
           ğŸ”¥ 1) ì²´í¬ë°•ìŠ¤ ON/OFF ì ìš©
           ----------------------------- */

        $(".widget-toggle").on("change", function () {
            const target = $(this).data("target");      // ì˜ˆ: "#widget-improve"
            const content = $(target).find(".widget-content");

            if ($(this).is(":checked")) content.show();
            else content.hide();

            // ì €ì¥
            const state = {};
            $(".widget-toggle").each(function () {
                state[$(this).data("target")] = $(this).is(":checked");
            });
            localStorage.setItem("widget_state", JSON.stringify(state));
        });

        /* -----------------------------
           ğŸ”¥ 2) ì €ì¥ëœ ìƒíƒœ ë³µì›
           ----------------------------- */

        const saved = JSON.parse(localStorage.getItem("widget_state") || "{}");

        for (const key in saved) {
            const checkbox = $(`.widget-toggle[data-target='${key}']`);
            const content = $(key).find(".widget-content");

            if (!saved[key]) {
                checkbox.prop("checked", false);
                content.hide();
            }
        }

        /* -----------------------------
           ğŸ”¥ 3) ë“œë˜ê·¸ ì •ë ¬ + LocalStorage ì €ì¥
           ----------------------------- */

        const savedOrder = JSON.parse(localStorage.getItem("widget_order") || "[]");

        // ì €ì¥ëœ ìˆœì„œëŒ€ë¡œ ì¬ë°°ì¹˜
        if (savedOrder.length > 0) {
            savedOrder.forEach(id => {
                const el = document.getElementById(id.replace("#", ""));
                if (el) document.getElementById("widgets-container").appendChild(el);
            });
        }

        Sortable.create(document.getElementById("widgets-container"), {
            animation: 150,
            handle: ".widget-block",  // ì¹´ë“œ ì „ì²´ë¥¼ ë“œë˜ê·¸
            onEnd: function () {
                const order = [];
                $("#widgets-container").children().each(function () {
                    order.push("#" + $(this).attr("id"));
                });
                localStorage.setItem("widget_order", JSON.stringify(order));
            }
        });

    });
</script>

{% endblock %}