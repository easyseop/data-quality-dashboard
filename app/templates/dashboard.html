{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center">
    <h2 class="mb-4">ğŸ“Š Data Quality Dashboard</h2>

    <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
    <div class="d-flex justify-content-end mb-3">
        <a href="/download/summary?date={{ selected_date }}" class="btn btn-success">
            ğŸ“¥ í†µê³„ì •ë³´ ìƒì„¸ ë‹¤ìš´ë¡œë“œ
        </a>
    </div>
</div>

<!-- ê¸°ì¤€ì¼ì + ê²€ì¦ì°¨ìˆ˜ + ê²€ì¦êµ¬ë¶„ ì„ íƒ -->
<div class="mb-3">
    <label><b>Target Date</b></label>
    <select id="dateFilter" class="form-select" style="width:260px;">
        {% for d in date_list %}
        <option value="/?date={{ d.base }}" {% if d.base == selected_date %}selected{% endif %}>
            {{ d['base'][2:4] }}ë…„ {{ d['cycle'] }} {{ d['type'] }} ê²€ì¦
        </option>
        {% endfor %}
    </select>
</div>

<hr class="my-4">

<!-- 1) ì „ì²´ KPI by DB Type -->
<h4 class="fw-bold mb-3">ğŸŒ Overall KPI by DB Type ({{ selected_date }})</h4>

<table class="table table-bordered table-striped align-middle text-center">
    <thead class="table-light">
        <tr>
            <th>DB Type</th>
            <th>Total</th>
            <th>Error</th>
            <th>Normal</th>
            <th>Error Rate</th>
        </tr>
    </thead>
    <tbody>
        {% for row in overall_kpi %}
        <tr>
            <td><b>{{ row.db_type }}</b></td>
            <td>{{ "{:,}".format(row.total_cnt) }}</td>
            <td class="text-danger fw-bold">{{ "{:,}".format(row.error_cnt) }}</td>
            <td class="text-success fw-bold">{{ "{:,}".format(row.normal_cnt) }}</td>
            <td>{{ (row.error_cnt / row.total_cnt * 100) | round(2) if row.total_cnt > 0 else 0 }}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<hr class="my-4">

<!-- 2) í’ˆì§ˆì§€ìˆ˜ ìš”ì•½ í‘œ -->
<h4 class="fw-bold mb-3">ğŸ” í’ˆì§ˆ ì ê²€ ê²°ê³¼ ìš”ì•½</h4>

<table class="table table-bordered table-sm text-center align-middle">
    <thead class="table-light">
        <tr>
            <th></th>
            <th>ê²€ì¦ì»¬ëŸ¼</th>
            <th>ì˜¤ë¥˜ì»¬ëŸ¼</th>
            <th>í’ˆì§ˆì§€ìˆ˜(%)</th>
        </tr>
    </thead>
    <tbody>
        <tr><td><b>ì „ì²´</b></td><td>{{ kpi_all.verified }}</td><td class="text-danger">{{ kpi_all.error }}</td><td><b>{{ kpi_all.quality }}%</b></td></tr>
        <tr><td>ì¸ìŠ¤í„´ìŠ¤(I)</td><td>{{ kpi_inst.verified }}</td><td class="text-danger">{{ kpi_inst.error }}</td><td>{{ kpi_inst.quality }}%</td></tr>
        <tr><td>ë‚ ì§œ(D)</td><td>{{ kpi_date.verified }}</td><td class="text-danger">{{ kpi_date.error }}</td><td>{{ kpi_date.quality }}%</td></tr>
        <tr><td>ëª©ë¡(L)</td><td>{{ kpi_list.verified }}</td><td class="text-danger">{{ kpi_list.error }}</td><td>{{ kpi_list.quality }}%</td></tr>
    </tbody>
</table>

<hr class="my-4">

<!-- 3) ì •ë¹„ê³„íš ë“±ë¡ë¥  -->
<h4 class="fw-bold mb-3">ğŸ›  ì •ë¹„ê³„íš ë“±ë¡ë¥  (ìµœê·¼ 3ê°œì›”)</h4>

<table class="table table-bordered table-striped text-center align-middle">
    <thead class="table-light">
        <tr>
            <th>ê¸°ì¤€ì¼ì</th>
            <th>ëŒ€ìƒê±´ìˆ˜</th>
            <th>ë“±ë¡ê±´ìˆ˜</th>
            <th>ì •ë¹„ê°€ëŠ¥</th>
            <th>ì •ë¹„ë¶ˆê°€ëŠ¥</th>
            <th>ë“±ë¡ë¥ (%)</th>
        </tr>
    </thead>
    <tbody>
        {% for row in maint_chart %}
        <tr>
            <td>{{ row.base_date }}</td>
            <td>{{ row.target_cnt }}</td>
            <td class="text-primary fw-bold">{{ row.registered_cnt }}</td>
            <td class="text-success fw-bold">{{ row.maint_yes }}</td>
            <td class="text-danger fw-bold">{{ row.maint_no }}</td>
            <td><b>{{ row.rate }}%</b></td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}

{% block scripts %}
<script>
document.getElementById("dateFilter").addEventListener("change", function(){
    window.location.href = this.value;
});
</script>
{% endblock %}
