{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center">
    <h2 class="mb-4">ğŸ“Š Data Quality Dashboard</h2>

    <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
    <div class="d-flex justify-content-end mb-3">
        <a href="/download/summary?date={{ selected_base }}" class="btn btn-success">
            ğŸ“¥ í†µê³„ì •ë³´ ìƒì„¸ ë‹¤ìš´ë¡œë“œ
        </a>
    </div>
</div>

<!-- í•„í„°: ë…„ë„ / ê²€ì¦êµ¬ë¶„ / ì°¨ìˆ˜ -->
<form method="get" action="/" class="row mb-3">

    <div class="col-md-2">
        <label><b>ë…„ë„</b></label>
        <select name="year" class="form-select" onchange="this.form.submit()">
            {% for y in year_list %}
            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>
                {{ y }}ë…„
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label><b>ê²€ì¦êµ¬ë¶„</b></label>
        <select name="dtype" class="form-select" onchange="this.form.submit()">
            <option value="ì •ê¸°" selected>ì •ê¸°</option>
            <option value="ìˆ˜ì‹œ" disabled>ìˆ˜ì‹œ (ì§€ì›ì•ˆí•¨)</option>
        </select>
    </div>


    <div class="col-md-2">
        <label><b>ì°¨ìˆ˜</b></label>
        <select name="cycle" class="form-select" onchange="this.form.submit()">
            {% for c in cycle_list %}
            <option value="{{ c }}" {% if c == selected_cycle %}selected{% endif %}>
                {{ c }}
            </option>
            {% endfor %}
        </select>
    </div>

</form>

<hr class="my-4">

<!-- 1) ì „ì²´ KPI by DB Type -->
<h4 class="fw-bold mb-3">
    ğŸŒ Overall KPI by DB Type ({{ selected_year[2:4] }}ë…„ {{ selected_cycle }} {{ selected_dtype }} ê²€ì¦)
</h4>

<table class="table table-bordered table-striped align-middle text-center">
    <thead class="table-light">
        <tr>
            <th>DB Type</th>
            <th>Total</th>
            <th>Error</th>
            <th>Normal</th>
            <th>Error Rate</th>
        </tr>
    </thead>
    <tbody>
        {% for row in overall_kpi %}
        <tr>
            <td><b>{{ row.db_type }}</b></td>
            <td>{{ "{:,}".format(row.total_cnt) }}</td>
            <td class="text-danger fw-bold">{{ "{:,}".format(row.error_cnt) }}</td>
            <td class="text-success fw-bold">{{ "{:,}".format(row.normal_cnt) }}</td>
            <td>{{ (row.error_cnt / row.total_cnt * 100) | round(2) if row.total_cnt > 0 else 0 }}%</td>
        </tr>
        {% endfor %}
        {% if overall_kpi|length == 0 %}
        <tr>
            <td colspan="5" class="text-muted">í•´ë‹¹ ì¡°ê±´ì— ëŒ€í•œ Summary ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
        </tr>
        {% endif %}
    </tbody>
</table>

<hr class="my-4">

<!-- 2) í’ˆì§ˆì§€ìˆ˜ ìš”ì•½ í‘œ -->
<h4 class="fw-bold mb-3">ğŸ” í’ˆì§ˆ ì ê²€ ê²°ê³¼ ìš”ì•½</h4>

<table class="table table-bordered table-sm text-center align-middle">
    <thead class="table-light">
        <tr>
            <th></th>
            <th>ê²€ì¦ì»¬ëŸ¼</th>
            <th>ì˜¤ë¥˜ì»¬ëŸ¼</th>
            <th>í’ˆì§ˆì§€ìˆ˜(%)</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><b>ì „ì²´</b></td>
            <td>{{ kpi_all.verified or 0 }}</td>
            <td class="text-danger">{{ kpi_all.error or 0 }}</td>
            <td><b>{{ kpi_all.quality or 0 }}%</b></td>
        </tr>
        <tr>
            <td>ì¸ìŠ¤í„´ìŠ¤(I)</td>
            <td>{{ kpi_inst.verified }}</td>
            <td class="text-danger">{{ kpi_inst.error }}</td>
            <td>{{ kpi_inst.quality }}%</td>
        </tr>
        <tr>
            <td>ë‚ ì§œ(D)</td>
            <td>{{ kpi_date.verified }}</td>
            <td class="text-danger">{{ kpi_date.error }}</td>
            <td>{{ kpi_date.quality }}%</td>
        </tr>
        <tr>
            <td>ëª©ë¡(L)</td>
            <td>{{ kpi_list.verified }}</td>
            <td class="text-danger">{{ kpi_list.error }}</td>
            <td>{{ kpi_list.quality }}%</td>
        </tr>
    </tbody>
</table>

<hr class="my-4">

<!-- 3) ì •ë¹„ê³„íš ë“±ë¡ë¥  -->
<h4 class="fw-bold mb-3">ğŸ›  ì •ë¹„ê³„íš ë“±ë¡ë¥  (ìµœê·¼ 3ê°œì›”)</h4>

<table class="table table-bordered table-striped text-center align-middle">
    <thead class="table-light">
        <tr>
            <th>ê¸°ì¤€ì¼ì</th>
            <th>ëŒ€ìƒê±´ìˆ˜</th>
            <th>ë“±ë¡ê±´ìˆ˜</th>
            <th>ì •ë¹„ê°€ëŠ¥</th>
            <th>ì •ë¹„ë¶ˆê°€ëŠ¥</th>
            <th>ë“±ë¡ë¥ (%)</th>
        </tr>
    </thead>
    <tbody>
        {% for row in maint_chart %}
        <tr>
            <td>{{ row.base_date }}</td>
            <td>{{ row.target_cnt }}</td>
            <td class="text-primary fw-bold">{{ row.registered_cnt }}</td>
            <td class="text-success fw-bold">{{ row.maint_yes }}</td>
            <td class="text-danger fw-bold">{{ row.maint_no }}</td>
            <td><b>{{ row.rate }}%</b></td>
        </tr>
        {% endfor %}
        {% if maint_chart|length == 0 %}
        <tr>
            <td colspan="6" class="text-muted">ì •ë¹„ê³„íš ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
        </tr>
        {% endif %}
    </tbody>
</table>

{% endblock %}
