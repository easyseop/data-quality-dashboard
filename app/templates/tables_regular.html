{% extends "layout.html" %}
{% block content %}

<h2>ğŸ“‚ ì •ê¸° í…Œì´ë¸” ëª©ë¡</h2>

<div class="row mb-3">
    <div class="col-md-2">
        <label><b>ë…„ë„</b></label>
        <select id="yearFilter" class="form-select">
            {% for y in year_list %}
            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}ë…„</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label><b>ì°¨ìˆ˜</b></label>
        <select id="cycleFilter" class="form-select">
            {% for c in cycle_list %}
            <option value="{{ c }}" {% if c == selected_cycle %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label><b>App Code</b></label>
        <select id="appFilter" class="form-select">
            <option value="ALL">ALL</option>
            {% for app in app_code_list %}
            <option value="{{ app }}" {% if app == selected_app %}selected{% endif %}>
                {{ app }}
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<table id="tableList" class="table table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>App Code</th>
            <th>Table Name</th>
            <th>Error Count</th>
            <th>Normal Count</th>
            <th>Error Rate</th>
        </tr>
    </thead>
    <tbody>
        {% for t in tables %}
        <tr>
            <td>{{ t["ì–´í”Œë¦¬ì¼€ì´ì…˜ì½”ë“œ"] }}</td>
            <td>{{ t["í…Œì´ë¸”ëª…"] }}</td>
            <td>{{ t["error_cnt"] }}</td>
            <td>{{ t["normal_cnt"] }}</td>
            <td>{{ t["error_rate"] }}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function () {

    // ğŸ”¥ DataTables ì´ˆê¸°í™”
    const table = $('#tableList').DataTable({
        pageLength: 50,
        ordering: true,
        order: [[4, 'desc']],
        searching: false,
        paging: false,
        stateSave: false,
        lengthChange: false
    });

    // ğŸ”¥ í•„í„° ë³€ê²½ â†’ URL ì¬ìƒì„±
    $("#yearFilter, #cycleFilter, #appFilter").on("change", function () {
        const year  = $("#yearFilter").val();
        const cycle = $("#cycleFilter").val();
        const app   = $("#appFilter").val();

        let url = `/tables/regular?year=${year}&cycle=${cycle}`;
        if (app) url += `&app=${app}`;
        window.location.href = url;
    });

    // ğŸ”¥ DataTables row í´ë¦­ â†’ detail ì´ë™
    table.on("click", "tbody tr", function () {
        const tableName = $(this).find("td:eq(1)").text().trim();
        const baseDate = "{{ selected_base }}";

        if (!tableName) return;

        window.location.href = `/detail/regular/${tableName}?date={{ selected_base }}`;

    });

});
</script>

{% endblock %}
